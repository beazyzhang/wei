<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Èü¶Ê∞è‰ºöÂõΩÂÖ¨ÊóèË∞±</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@500&display=swap" rel="stylesheet">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            font-family: 'Noto Serif SC', serif;
            background-color: #000;
            color: #d4a76a;
            margin: 0;
            padding: 20px;
        }
        
        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-bottom: 20px;
        }
        
        .header {
            text-align: center;
            width: 100%;
        }
        
        .header h1 {
            color: #d4a76a;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.3);
            margin-bottom: 10px;
        }
        
        .header h1::before {
            content: 'üèÆ';
            margin-right: 15px;
            font-size: 0.8em;
        }
        
        .header h3 {
            color: #8d6e63;
            font-weight: normal;
            margin-bottom: 0;
        }
        
        /* Ê∑ªÂä†ÊÑüÂèπÂè∑Ê≥®ÈáäÊ†∑Âºè */
        .info-icon {
            display: inline-block;
            width: 18px;
            height: 18px;
            background-color: #d4a76a;
            color: #000;
            border-radius: 50%;
            text-align: center;
            line-height: 18px;
            font-size: 14px;
            font-weight: bold;
            margin-left: 10px;
            cursor: pointer;
            transition: all 0.3s;
            vertical-align: middle;
        }
        
        .info-icon:hover {
            background-color: #c09559;
            transform: scale(1.1);
        }
        
        .history-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .history-content {
            background-color: rgba(0, 0, 0, 0.9);
            border: 2px solid #d4a76a;
            border-radius: 8px;
            padding: 25px;
            width: 80%;
            max-width: 600px;
            color: #d4a76a;
            position: relative;
            box-shadow: 0 0 20px rgba(212, 167, 106, 0.3);
        }
        
        .history-content h3 {
            text-align: center;
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 22px;
            border-bottom: 1px solid rgba(212, 167, 106, 0.3);
            padding-bottom: 10px;
        }
        
        .ancestry-chart {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 20px 0;
            padding: 15px;
            background-color: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(212, 167, 106, 0.3);
            border-radius: 5px;
        }
        
        .ancestor {
            text-align: center;
            padding: 10px 15px;
            margin: 5px 0;
            background-color: rgba(212, 167, 106, 0.1);
            border: 1px solid rgba(212, 167, 106, 0.5);
            border-radius: 5px;
            font-size: 16px;
            font-weight: bold;
            min-width: 200px;
        }
        
        .ancestor-title {
            display: block;
            font-size: 12px;
            font-weight: normal;
            color: #a88c5d;
            margin-top: 5px;
        }
        
        .ancestor-line {
            height: 20px;
            width: 2px;
            background-color: #d4a76a;
        }
        
        .current-ancestor {
            background-color: rgba(212, 167, 106, 0.3);
            border: 2px solid #d4a76a;
        }
        
        .history-content p {
            line-height: 1.8;
            font-size: 16px;
            text-indent: 2em;
            margin-bottom: 15px;
        }
        
        .history-content .signature {
            text-align: right;
            text-indent: 0;
            font-style: italic;
            margin-top: 20px;
            margin-bottom: 5px;
        }
        
        .close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 24px;
            color: #d4a76a;
            cursor: pointer;
            transition: color 0.3s;
        }
        
        .close-btn:hover {
            color: #c09559;
        }
        
        /* ÂÖ∂‰ªñÊ†∑Âºè‰øùÊåÅ‰∏çÂèò */
        
        .family-rules {
            position: absolute;
            top: 20px;
            left: 20px;
            width: 380px;
            padding: 10px;
            background-color: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(212, 167, 106, 0.3);
            border-radius: 5px;
            font-size: 12px;
            line-height: 1.5;
            color: #d4a76a;
            z-index: 100;
            max-height: calc(100vh - 93px);
            text-align: center;
            overflow-y: auto;
        }
        
        .family-rules h4 {
            margin-top: 0;
            margin-bottom: 5px;
            font-weight: bold;
            text-align: center;
            font-size: 14px;
        }
        
        .family-rules p {
            margin: 0;
            text-align: center;
        }
        
        .editor-panel {
            display: flex;
            flex-direction: row;
            gap: 10px;
            padding: 10px;
            border: 1px solid #d4a76a;
            border-radius: 5px;
            background-color: rgba(0, 0, 0, 0.5);
            margin-bottom: 0;
            position: absolute;
            right: 20px;
            bottom: calc(100vh - 93px - 20px);
            height: fit-content;
            z-index: 100;
        }
        
        .editor-panel button {
            background: #d4a76a;
            color: #000;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            width: 100px;
            text-align: center;
            transition: background-color 0.3s;
        }
        
        .editor-panel button:hover {
            background-color: #c09559;
        }
        
        .file-upload {
            position: relative;
            display: inline-block;
        }
        
        .file-upload input[type="file"] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        
        .file-upload label {
            background: #d4a76a;
            color: #000;
            padding: 8px 16px;
            border-radius: 5px;
            display: inline-block;
            cursor: pointer;
            width: 68px;
            text-align: center;
            transition: background-color 0.3s;
        }
        
        .file-upload label:hover {
            background-color: #c09559;
        }
        
        #family-tree {
            width: 100%;
            height: calc(100vh - 180px); /* ‰ªé200pxÂáèÂ∞ëÂà∞180pxÔºåÁõ∏ÂΩì‰∫éÂ¢ûÂä†20pxÈ´òÂ∫¶ */
            border: 2px solid #d4a76a;
            border-radius: 5px;
            overflow: hidden;
            margin-top: 20px; /* ‰∏é‰∏äÊñπÂÖÉÁ¥†‰øùÊåÅ‰∏ÄÂÆöË∑ùÁ¶ª */
        }
        
        .node circle {
            fill: #f9e8c7;
            stroke: #d4a76a;
            stroke-width: 2px;
            transition: fill 0.3s;
        }
        
        .ancestor-node circle {
            fill: rgba(249, 232, 199, 0.6);
            stroke: rgba(212, 167, 106, 0.7);
            stroke-width: 1.5px;
        }
        
        .ancestor-node text {
            opacity: 0.8;
        }
        
        .node:hover circle {
            fill: #e6d0a9;
        }
        
        .ancestor-node:hover circle {
            fill: rgba(230, 208, 169, 0.7);
        }
        
        .node text {
            font: 12px 'Noto Serif SC';
            pointer-events: none;
        }
        
        .link {
            fill: none;
            stroke: #8d6e63;
            stroke-width: 2px;
        }
        
        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: #d4a76a;
            border: 1px solid #d4a76a;
            border-radius: 5px;
            padding: 10px;
            pointer-events: none;
            opacity: 0;
            max-width: 250px;
            transition: opacity 0.3s;
        }
        
        .context-menu {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            color: #d4a76a;
            border: 1px solid #d4a76a;
            border-radius: 5px;
            padding: 5px 0;
            z-index: 1000;
        }
        
        .context-menu div {
            padding: 8px 15px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .context-menu div:hover {
            background: rgba(212, 167, 106, 0.2);
        }
        
        .generation-label {
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div class="family-rules">
        <h4>ÂêàÊóèÂÖ¨Á∫¶ÂÖ´Êù°</h4>
        <p>‰∏Ä„ÄÅÊú¨ÊóèÂêå‰∫∫Â∫îÈÅµÂÆàÂõΩÂÆ∂Ê≥ïÂæã„ÄÇ‰∫å„ÄÅ‰∏çÂæóË¥™Ê±°ÁõóÁ™É„ÄÅ‰∏çÂæóÂ•∏Ê∑´Ë∞ÉÊàèÂ¶áÂ•≥„ÄÇ‰∏â„ÄÅ‰∏çÂæóÂê∏ÊØí„ÄÅËµåÂçö„ÄÇÂõõ„ÄÅ‰∏çÂæóËØ¨ÂëäÈô∑ÂÆ≥‰ªñ‰∫∫„ÄÇ‰∫î„ÄÅ‰∏çÂæóÊ¨∫ÂéãÂíåÊâìÈ™Ç‰ªñ‰∫∫„ÄÇÂÖ≠„ÄÅ‰∏çÂæóË¥•ÂùèÊóèÊúõ„ÄÇ‰∏É„ÄÅË¶ÅÂ∞äËÄÅÁà±Âπº„ÄÅÁù¶ÊóèÂíåÈÇª„ÄÇÂÖ´„ÄÅ‰∏çÂáÜÊìÖËá™Âà†ÊîπÊóèË∞±ÂÜÖËÆ∞ËΩΩ„ÄÇ</p>
    </div>
    
    <div class="header-container">
        <div class="header">
            <h1>Èü¶Ê∞è‰ºöÂõΩÂÖ¨ÊóèË∞±</h1>
            <h3>‰º†ÊâøÊúâÂ∫è Â∞äÁ•ñÊï¨ÂÆó<span class="info-icon" id="historyInfo">!</span></h3>
        </div>
    </div>
    
    <!-- Ê∑ªÂä†ÂéÜÂè≤‰ø°ÊÅØÊ®°ÊÄÅÊ°Ü -->
    <div class="history-modal" id="historyModal">
        <div class="history-content">
            <span class="close-btn" id="closeModal">&times;</span>
            <h3>‰ºöÂõΩÂÖ¨Âè≤Áï•</h3>
            <div class="ancestry-chart">
                <div class="ancestor">Èü¶Â∫îÈÇ¶ÔºàÊõæÁ•ñÁà∂Ôºâ<br><span class="ancestor-title">ÂçóÂÆãÈí¶ÁÇπÊ≠¶Áä∂ÂÖÉÔºåÂú®Âçó‰∫¨Á´ãÂ∫îÂ§©Â∫úÔºåÂÖÉÊúùÂ±±‰∏úÊèêÁù£</span></div>
                <div class="ancestor-line"></div>
                <div class="ancestor">Èü¶ÂΩ¶Êò•ÔºàÁ•ñÁà∂Ôºâ<br><span class="ancestor-title">ÂÖÉÊúùÂÖµÈÉ®ÂâåÈÉéÔºåÂ∞ÜÂÜõ<br>Â•âÊó®È¢ÜÂÖ´ÂçÉÂ∞ÜÂ£´ÈïáÂÆà‰∫îÁæäÂüéÔºàÂπøÂ∑ûÔºâÔºåÁ´ãÂçóÈõÑÂ∫ú</span></div>
                <div class="ancestor-line"></div>
                <div class="ancestor">Èü¶ËÉúÁôªÔºàÁà∂‰∫≤Ôºâ<br><span class="ancestor-title">Ê≠¶ÂÆò</span></div>
                <div class="ancestor-line"></div>
                <div class="ancestor current-ancestor">Èü¶‰ºöÂõΩ<br><span class="ancestor-title">ÊòéÊúùÂÖµÈÉ®Â∞ö‰π¶ÔºåÊ≠£‰∫åÂìÅÔºåÂ§ßÂ∞ÜÂÜõ</span></div>
            </div>
            <p>Èü¶‰ºöÂõΩÁ≥ªÊòéÊúùÂÖµÈÉ®Â∞ö‰π¶ÔºåÊ≠£‰∫åÂìÅÔºåÂ§ßÂ∞ÜÂÜõÔºåÊ≠¶ÂÆòËÉúÁôªÂÖ¨‰πãÂ≠ê„ÄÇ</p>
            <p>‰∫éÊòéÊúùÊ¥™Ê≠¶ÂçÅ‰∏ÄÂπ¥ÔºàÂÖ¨ÂÖÉ 1378 Âπ¥ÔºâÊàäÂçàÂπ¥‰∫îÊúàÂªø‰∏ÉÊó•ÂØÖÊó∂Âú®ÂçóÈõÑÂá∫Áîü„ÄÇÂÖ∂Á•ñÁà∂Èü¶ÂΩ¶Êò•ÊòØÂÖÉÊúùÂÖµÈÉ®ÂâåÈÉéÔºåÂ∞ÜÂÜõ„ÄÇÂ•âÊó®È¢ÜÂÖ´ÂçÉÂ∞ÜÂ£´ÈïáÂÆà‰∫îÁæäÂüéÔºàÂπøÂ∑ûÔºâÔºåÁ´ãÂçóÈõÑÂ∫úÔºåËêΩÁ±çÂçóÈõÑË•øË°ó„ÄÇÊõæÁ•ñÁà∂Èü¶Â∫îÈÇ¶ÊòØÂçóÂÆãÈí¶ÁÇπÊ≠¶Áä∂ÂÖÉÔºåÂú®Âçó‰∫¨Á´ãÂ∫îÂ§©Â∫úÔºåÂÖÉÊúùÂ±±‰∏úÊèêÁù£„ÄÇ‰∏äÊúù‰ºöÂõΩÂÖ¨Áõ¥Á≥ªÂÆó‰∫≤ÔºåÊúâÊ±âÊúùÁà∂Â≠ê‰∏ûÁõ∏Èü¶Ë¥§„ÄÅÈü¶ÁéÑÊàêÔºåÈöèÊúùÊ∞ëÈÉ®Â∞ö‰π¶Èü¶Êå∫ÔºåÂîêÊúùÂ∞ö‰π¶Âè≥‰∏ûÁõ∏Èü¶Êå∫ÔºåÂÖ∂Â≠êÈü¶ÂæÖ‰ª∑Ê≠£‰∫åÂìÅÊñáÊòåÂè≥‰∏ûÁõ∏„ÄÇ‰ºöÂõΩÂÖ¨‰∏äÊâøÂÖàÁ•ñË°ÄËÑâÔºå‰∫éÊòéÊ¥™Ê≠¶ÂªøÂÖ≠Âπ¥ÔºàÊó∂Âπ¥ÂçÅÂÖ≠Â≤ÅÔºâÊÅ©ÊéàÂç´ÂçÉÊÄªÊ≠¶ÂÆòÔºåÂ•âÊó®‰ªéÂçóÈõÑÈ¢ÜÂÖµ‰∏ÄÂçÉÔºåËÅî‰∫åÂçÅÂõõÂßìÂÆàÈæôÊ∞¥ÂüéÂéøÔºà‰ªäÁΩóÂÆöÂ∏ÇÔºâÔºåÊ¥™Ê≠¶ÂªøÂÖ´Âπ¥ÂõûÂçóÈõÑÊé•ÂÆ∂Áú∑Âà∞ÈæôÊ∞¥‰ª™Âá§Â≤óÔºàÁΩóÂÆöÂàÜÁïåÁü≥ÊéíÊùëÔºåÂ±ãÂú∞ÂΩ¢ÔºöÁäÄÁâõÂñ∑Ê∞¥ÔºâÂÆöÂ±ÖÔºåÁΩÆÁî∞‰∏âÁü≥ÂÖ≠Êñó„ÄÇÂÆ£Âæ∑ÂõõÂπ¥Ôºà1429 Âπ¥Ôºå‰∫îÂçÅ‰∏ÄÂ≤ÅÔºâ‰∏≠Ê≠¶ËøõÂ£´ÔºåÂÖ•ÊúùÔºàÂåó‰∫¨ÔºâÂÆòÂçáÊ≠£‰∫åÂìÅÂÖµÈÉ®Â∞ö‰π¶ÔºàÁõ∏ÂΩìÁé∞Âú®ÁöÑÂõΩÈò≤ÈÉ®ÈïøÔºâÂ§ßÂ∞ÜÂÜõÔºåÂ§´‰∫∫ÊùéÊ∞è„ÄÅÊù®Ê∞èÔºåÁîü‰πùÂ≠êÔºöÊª®‰∫ÆÔºàÈò≥Êò•Ôºâ„ÄÅÊµ∑‰∫ÆÔºà‰∫ëÊµÆÔºâ„ÄÅÊ≥ï‰∫ÆÔºàÁΩóÂÆöÔºâ„ÄÅÊ±â‰∫ÆÔºàÂçóÊµ∑Ôºâ„ÄÅÊ∏≠‰∫ÆÔºàÂ≤ëÊ∫™Ôºâ„ÄÅÊ±ü‰∫ÆÔºàÁ¶èÂª∫Ôºâ„ÄÅÊ≤≥‰∫ÆÔºàÊñ∞‰ºöÔºâ„ÄÅÊΩÆ‰∫ÆÔºàÊ¢ÖÂ∑ûÔºâ„ÄÅÊ∏≠‰∫ÆÔºà‰πùÊ±üÔºâÔºåÂùá‰∏∫Ê≠¶ÂÆò„ÄÇ‰ºöÂõΩÂÖ¨Âú®ÊúùÂª∑‰ªªËÅåÂªøÂÖ´Âπ¥ÔºåÊôöÂπ¥ÂõûÁΩóÂÆöÂàÜÁïåÂ±Ö‰Ωè„ÄÇÁªà‰∫éÊòéÊúùÊàêÂåñÂÖ≠Âπ¥Ôºà1470 Âπ¥ÔºâÂçÅÊúàÂàù‰πùÊó•ÔºåÈò≥ÂØø‰πùÂçÅ‰∏âÂ≤Å„ÄÇÂàùËë¨Ê∞¥ÊëÜÊúùÁè†ÔºàÁå™ÔºâÂ≤≠ÔºàÂ±±ÂΩ¢ÔºöÁåõËôéÊìíÁå™ÔºâÔºåËá≥Ê∏ÖÂÖâÁª™Áî≤Áî≥Âπ¥ÂçÅ‰∫åÊúà‰∫åÂçÅÊó•Ëæ∞Êó∂ËøÅËë¨ÁΩóÈïú‰ª™Âá§Ê°•ÔºåÂú∞ÂΩ¢‰∏∫Â§©ÈπÖÂ≠µËõãÔºåÂú®Ê≥ï‰∫ÆÂ∞ÜÂÜõÂ¢ìÂè≥‰æßÔºå‰∏éÂ§´‰∫∫ÊùéÊ∞èÂêåÁ©¥ÔºåÂùêÂ∫öÂêëÁî≤ÂÖºÁî≥ÂØÖ„ÄÇ</p>
            <p>‰ºöÂõΩÂÖ¨ÂêéË£îÂàÜÂ∏ÉÂú®ÂõΩÂÜÖÂ§ñÊúâÊï∞ÂçÅ‰∏á‰∫∫„ÄÇ</p>
            <p class="signature">ÂçÅÂÖ´‰∏ñË£îÂ≠ô Èü¶Ê∞∏ÁêÉ Êí∞Á®ø</p>
            <p class="signature">ÂªøÂõõ‰∏ñË£îÂ≠ô Èü¶Á´†Âª∫</p>
        </div>
    </div>
    <div class="editor-panel">
        <button id="add-generation-btn">Êñ∞Âª∫‰∏ñ‰ª£</button>
        <button id="save-data-btn">‰øùÂ≠òÊï∞ÊçÆ</button>
        <button id="export-data-btn">ÂØºÂá∫Êï∞ÊçÆ</button>
        <div class="file-upload">
            <label for="importFile">ÂØºÂÖ•Êï∞ÊçÆ</label>
            <input type="file" id="importFile" accept=".json">
        </div>
    </div>
    
    <div id="family-tree"></div>
    
     <script>
        // ÂàùÂßãÊï∞ÊçÆ
        let familyData = JSON.parse(localStorage.getItem('familyData')) || {
            name: 'Èü¶Â∫îÈÇ¶(ÊõæÁ•ñ)',
            birth: "ÂçóÂÆã",
            intro: "ÂçóÂÆãÈí¶ÁÇπÊ≠¶Áä∂ÂÖÉÔºåÂú®Âçó‰∫¨Á´ãÂ∫îÂ§©Â∫úÔºåÂÖÉÊúùÂ±±‰∏úÊèêÁù£",
            isAncestor: true,
            children: [{
                name: 'Èü¶ÂΩ¶Êò•(Á•ñÁà∂)',
                birth: "ÂÖÉÊúù",
                intro: "ÂÖÉÊúùÂÖµÈÉ®ÂâåÈÉéÔºåÂ∞ÜÂÜõÔºåÂ•âÊó®È¢ÜÂÖ´ÂçÉÂ∞ÜÂ£´ÈïáÂÆà‰∫îÁæäÂüéÔºàÂπøÂ∑ûÔºâÔºåÁ´ãÂçóÈõÑÂ∫ú",
                isAncestor: true,
                children: [{
                    name: 'Èü¶ËÉúÁôª(Áà∂‰∫≤)',
                    birth: "ÂÖÉÊú´ÊòéÂàù",
                    intro: "Ê≠¶ÂÆò",
                    isAncestor: true,
                    children: [
                        {
                            name: 'Èü¶‰ºöÊñá(ÂÖÑ)',
                            birth: "ÊòéÊúù",
                            intro: "Èü¶‰ºöÂõΩ‰πãÂÖÑ",
                            isAncestor: true,
                            children: []
                        },
                        {
                            name: 'Èü¶‰ºöÂõΩ(ÂßãÁ•ñ)',
                            birth: "ÊòéÊúùÊ¥™Ê≠¶ÂçÅ‰∏ÄÂπ¥ÔºàÂÖ¨ÂÖÉ1378Âπ¥Ôºâ",
                            spouse: "ÊùéÊ∞è„ÄÅÊù®Ê∞è",
                            intro: "ÊòéÊúùÂÖµÈÉ®Â∞ö‰π¶ÔºåÊ≠£‰∫åÂìÅÔºåÂ§ßÂ∞ÜÂÜõ",
                            children: []
                        },
                        {
                            name: 'Èü¶‰ºöÊ≠¶(Âºü)',
                            birth: "ÊòéÊúù",
                            intro: "Èü¶‰ºöÂõΩ‰πãÂºü",
                            isAncestor: true,
                            children: []
                        }
                    ]
                }]
            }]
        };
        
        // ÂÖ®Â±ÄÂèòÈáè
        let svg, g, zoom;
        let width, height;
        let tree;
        let tooltip;
        let contextMenu;
        const chineseNumbers = ["‰∏Ä", "‰∫å", "‰∏â", "Âõõ", "‰∫î", "ÂÖ≠", "‰∏É", "ÂÖ´", "‰πù", "ÂçÅ", 
                              "ÂçÅ‰∏Ä", "ÂçÅ‰∫å", "ÂçÅ‰∏â", "ÂçÅÂõõ", "ÂçÅ‰∫î", "ÂçÅÂÖ≠", "ÂçÅ‰∏É", "ÂçÅÂÖ´", "ÂçÅ‰πù", "‰∫åÂçÅ"];
        
        // DOM Âä†ËΩΩÂÆåÊàêÂêéÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            // ÂàùÂßãÂåñ‰∫ã‰ª∂ÁõëÂê¨
            initEventListeners();
            
            // ÂàùÂßãÂåñÊ†ëÂõæ
            initializeTree();
            
            // Á™óÂè£Â§ßÂ∞èÂèòÂåñÊó∂ÈáçÊñ∞ÂàùÂßãÂåñ
            window.addEventListener('resize', debounce(initializeTree, 250));
        });
        
        // ÂàùÂßãÂåñ‰∫ã‰ª∂ÁõëÂê¨
        function initEventListeners() {
            document.getElementById('add-generation-btn').addEventListener('click', addGeneration);
            document.getElementById('save-data-btn').addEventListener('click', saveData);
            document.getElementById('export-data-btn').addEventListener('click', exportData);
            document.getElementById('importFile').addEventListener('change', importData);
            
            // Ê∑ªÂä†ÂéÜÂè≤‰ø°ÊÅØÁÇπÂáª‰∫ã‰ª∂
            document.getElementById('historyInfo').addEventListener('click', function() {
                document.getElementById('historyModal').style.display = 'flex';
            });
            
            document.getElementById('closeModal').addEventListener('click', function() {
                document.getElementById('historyModal').style.display = 'none';
            });
            
            // ÁÇπÂáªÊ®°ÊÄÅÊ°ÜÂ§ñÈÉ®ÂÖ≥Èó≠
            document.getElementById('historyModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    this.style.display = 'none';
                }
            });
            
            // ÁÇπÂáªÈ°µÈù¢‰ªªÊÑè‰ΩçÁΩÆÂÖ≥Èó≠‰∏ä‰∏ãÊñáËèúÂçï
            document.addEventListener('click', function() {
                hideContextMenu();
            });
        }
        
        // Èò≤ÊäñÂáΩÊï∞
        function debounce(func, wait) {
            let timeout;
            return function() {
                const context = this;
                const args = arguments;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), wait);
            };
        }
        
        // ÂàùÂßãÂåñÊ†ëÂõæ
        function initializeTree() {
            // Ê∏ÖÈô§Áé∞ÊúâÂÜÖÂÆπ
            d3.select("#family-tree").html("");
            
            // Ëé∑ÂèñÂÆπÂô®Â∞∫ÂØ∏
            const container = document.getElementById('family-tree');
            width = container.clientWidth;
            height = container.clientHeight;
            
            // ÂàõÂª∫SVG
            svg = d3.select("#family-tree")
                .append("svg")
                .attr("width", width)
                .attr("height", height);
            
            // Ê∑ªÂä†Áº©ÊîæÂäüËÉΩ
            zoom = d3.zoom()
                .scaleExtent([0.1, 3])
                .on("zoom", (event) => {
                    g.attr("transform", event.transform);
                });
            
            svg.call(zoom);
            
            // ÂàõÂª∫‰∏ªË¶ÅÂõæÂΩ¢ÁªÑ
            g = svg.append("g");
            
            // ÂàõÂª∫Ê†ëÂ∏ÉÂ±Ä
            tree = d3.tree()
                .nodeSize([80, 120])
                .separation((a, b) => a.parent === b.parent ? 1.5 : 2);
            
            // ÂàõÂª∫ÊèêÁ§∫Ê°Ü
            tooltip = d3.select("body").append("div")
                .attr("class", "tooltip");
            
            // Ê∏≤ÊüìÊ†ë
            updateTree();
        }
        
        // Êõ¥Êñ∞Ê†ëÂõæ
        function updateTree() {
            // Â§ÑÁêÜÊï∞ÊçÆ
            const root = d3.hierarchy(familyData);
            
            // ‰øùÁïôÊäòÂè†Áä∂ÊÄÅ
            root.descendants().forEach(d => {
                if (d.data.collapsed) {
                    d._children = d.children;
                    d.children = null;
                }
            });
            
            // ËÆ°ÁÆóËäÇÁÇπ‰ΩçÁΩÆ
            tree(root);
            
            // Ê∏ÖÈô§Áé∞ÊúâÂÜÖÂÆπ
            g.selectAll("*").remove();
            
            // ÁªòÂà∂ËøûÊé•Á∫ø
            drawLinks(root);
            
            // ÁªòÂà∂ËäÇÁÇπ
            drawNodes(root);
            
            // Ê∑ªÂä†‰ª£ÈôÖÊ†áËØÜ
            addGenerationLabels(root);
            
            // Â±Ö‰∏≠ÊòæÁ§∫Ê†ë
            centerTree(root);
        }
        
        // ÁªòÂà∂ËøûÊé•Á∫ø
        function drawLinks(root) {
            g.selectAll(".link")
                .data(root.links())
                .enter()
                .append("path")
                .attr("class", "link")
                .attr("d", d => {
                    return `M${d.source.x},${d.source.y}
                            L${d.source.x},${(d.source.y + d.target.y) / 2}
                            L${d.target.x},${(d.source.y + d.target.y) / 2}
                            L${d.target.x},${d.target.y}`;
                });
        }
        
        // ÁªòÂà∂ËäÇÁÇπ
        function drawNodes(root) {
            const nodes = g.selectAll(".node")
                .data(root.descendants())
                .enter()
                .append("g")
                .attr("class", d => d.data.isAncestor ? "node ancestor-node" : "node")
                .attr("transform", d => `translate(${d.x},${d.y})`)
                .on("click", toggleChildren)
                .on("contextmenu", showContextMenu)
                .on("mouseover", showTooltip)
                .on("mouseout", hideTooltip);
            
            // ÁªòÂà∂ËäÇÁÇπÂúÜÂΩ¢
            nodes.append("circle")
                .attr("r", 30)
                .attr("fill", d => d.data.isAncestor ? "rgba(249, 232, 199, 0.6)" : "#f9e8c7")
                .attr("stroke", d => d.data.isAncestor ? "rgba(212, 167, 106, 0.7)" : "#d4a76a");
            
            // ‰∏∫Êî∂Ëµ∑ÁöÑËäÇÁÇπÊ∑ªÂä†ÁâπÊÆäÊ†áËØÜ
            nodes.filter(d => d._children)
                .append("text")
                .attr("class", "collapsed-indicator")
                .text("+")
                .attr("x", 0)
                .attr("y", 40)
                .attr("dy", "0.3em")
                .attr("text-anchor", "middle")
                .attr("fill", "#d4a76a")
                .attr("font-size", "20px");
            
            // ÁªòÂà∂ËäÇÁÇπÊñáÊú¨
            nodes.append("text")
                .text(d => d.data.name)
                .attr("dy", "0.3em")
                .attr("text-anchor", "middle")
                .attr("fill", d => d.data.isAncestor ? "rgba(0, 0, 0, 0.6)" : "#000");
        }
        
        // Ê∑ªÂä†‰ª£ÈôÖÊ†áËØÜ
        function addGenerationLabels(root) {
            const maxDepth = d3.max(root.descendants(), d => d.depth);
            
            // ÊâæÂà∞ÊØè‰∏™Ê∑±Â∫¶ÁöÑËäÇÁÇπ
            const depthNodes = {};
            root.descendants().forEach(node => {
                if (!depthNodes[node.depth]) {
                    depthNodes[node.depth] = [];
                }
                depthNodes[node.depth].push(node);
            });
            
            // ‰∏∫ÊØè‰∏™Ê∑±Â∫¶Ê∑ªÂä†‰ª£ÈôÖÊ†áËØÜ
            for (let i = 0; i <= maxDepth; i++) {
                if (depthNodes[i] && depthNodes[i].length > 0) {
                    if (i === 0) {
                        // Á¨¨‰∏Ä‰ª£ÁöÑËäÇÁÇπ
                        addFirstGenerationLabel(depthNodes[i][0]);
                    } else if (i === 1) {
                        // Á¨¨‰∫å‰ª£ÁöÑËäÇÁÇπ
                        addSecondGenerationLabel(depthNodes[0][0]);
                    } else {
                        // ÂÖ∂‰ªñ‰ª£ÁöÑÊ†áËØÜÂ§ÑÁêÜÈÄªËæë
                        addOtherGenerationLabels(i, depthNodes[i-1]);
                    }
                }
            }
        }
        
        // Ê∑ªÂä†Á¨¨‰∏Ä‰ª£Ê†áËØÜ
        function addFirstGenerationLabel(node) {
            g.append("text")
                .attr("class", "generation-label")
                .text("‰∏Ä‰∏ñ")
                .attr("x", node.x)
                .attr("y", node.y - 45)
                .attr("dy", "0.3em")
                .attr("text-anchor", "middle")
                .attr("fill", "#d4a76a")
                .attr("font-size", "16px");
        }
        
        // Ê∑ªÂä†Á¨¨‰∫å‰ª£Ê†áËØÜ
        function addSecondGenerationLabel(firstGenNode) {
            g.append("text")
                .attr("class", "generation-label")
                .text("‰∫å‰∏ñ")
                .attr("x", firstGenNode.x)
                .attr("y", firstGenNode.y + 75)
                .attr("dy", "0.3em")
                .attr("text-anchor", "middle")
                .attr("fill", "#d4a76a")
                .attr("font-size", "16px");
        }
        
        // Ê∑ªÂä†ÂÖ∂‰ªñ‰ª£ÈôÖÊ†áËØÜ
        function addOtherGenerationLabels(generation, parentNodes) {
            // ÊâæÂà∞ÂΩìÂâçÊ∑±Â∫¶‰∏≠ÊúâÂ≠êËäÇÁÇπ‰∏îÂ∑≤Â±ïÂºÄÁöÑËäÇÁÇπ
            const expandedParents = parentNodes.filter(node => 
                node.children && node.children.length > 0
            );
            
            // ‰∏∫ÊØè‰∏™Â±ïÂºÄÁöÑÁà∂ËäÇÁÇπÊ∑ªÂä†‰∏ã‰∏Ä‰ª£Ê†áËØÜ
            expandedParents.forEach(parent => {
                g.append("text")
                    .attr("class", "generation-label")
                    .text(chineseNumbers[generation] + "‰∏ñ")
                    .attr("x", parent.x)
                    .attr("y", parent.y + 75)
                    .attr("dy", "0.3em")
                    .attr("text-anchor", "middle")
                    .attr("fill", "#d4a76a")
                    .attr("font-size", "16px");
            });
        }
        
        // Â±Ö‰∏≠ÊòæÁ§∫Ê†ë
        function centerTree(root) {
            const rootNode = root.descendants()[0];
            const initialTransform = d3.zoomIdentity
                .translate(width / 2 - rootNode.x, 100 - rootNode.y)
                .scale(0.8);
            
            svg.call(zoom.transform, initialTransform);
        }
        
        // ÊäòÂè†/Â±ïÂºÄÂ≠êËäÇÁÇπ
        function toggleChildren(event, d) {
            event.stopPropagation();
            
            if (d.children) {
                d._children = d.children;
                d.children = null;
                d.data.collapsed = true;
            } else if (d._children) {
                d.children = d._children;
                d._children = null;
                d.data.collapsed = false;
            }
            updateTree();
        }
        
        // ÊòæÁ§∫ÊèêÁ§∫Ê°Ü
        function showTooltip(event, d) {
            let content = `<strong>${d.data.name}</strong>`;
            
            if (d.data.birth && d.data.birth !== 'ÂæÖË°•ÂÖÖ') {
                content += `<br/>ÁîüËæ∞Ôºö${d.data.birth}`;
            }
            
            if (d.data.spouse && d.data.spouse !== 'ÂæÖË°•ÂÖÖ' && !d.data.isSpouse) {
                content += `<br/>ÈÖçÂÅ∂Ôºö${d.data.spouse}`;
            }
            
            if (d.data.intro && d.data.intro !== 'ÂæÖË°•ÂÖÖ') {
                content += `<br/>ÁÆÄ‰ªãÔºö${d.data.intro}`;
            }
            
            if (d.data.residence && d.data.residence !== 'ÂæÖË°•ÂÖÖ') {
                content += `<br/>Â±Ö‰ΩèÂú∞Ôºö${d.data.residence}`;
            }
            
            tooltip.html(content)
                .style("left", (event.pageX + 10) + "px")
                .style("top", (event.pageY - 28) + "px")
                .style("opacity", 0.9);
        }
        
        // ÈöêËóèÊèêÁ§∫Ê°Ü
        function hideTooltip() {
            tooltip.style("opacity", 0);
        }
        
        // ÊòæÁ§∫Âè≥ÈîÆËèúÂçï
        function showContextMenu(event, d) {
            event.preventDefault();
            event.stopPropagation();
            
            // ÁßªÈô§Áé∞ÊúâËèúÂçï
            hideContextMenu();
            
            // ÂàõÂª∫ËèúÂçï
            contextMenu = d3.select("body")
                .append("div")
                .attr("class", "context-menu")
                .style("left", event.pageX + "px")
                .style("top", event.pageY + "px");
            
            // Ê∑ªÂä†ËèúÂçïÈ°π
            const options = [
                { text: 'Ê∑ªÂä†ÊàêÂëò', action: () => addMemberPrompt(d.data.name) },
                { text: 'Ê∑ªÂä†ÈÖçÂÅ∂', action: () => addSpouseToMember(d.data.name) },
                { text: '‰øÆÊîπÊàêÂëò', action: () => editMember(d.data.name) },
                { text: 'Âà†Èô§ÊàêÂëò', action: () => confirmDeleteMember(d.data.name) }
            ];
            
            options.forEach(option => {
                contextMenu.append("div")
                    .text(option.text)
                    .on("click", (e) => {
                        e.stopPropagation();
                        hideContextMenu();
                        option.action();
                    });
            });
        }
        
        // ÈöêËóèÂè≥ÈîÆËèúÂçï
        function hideContextMenu() {
            d3.selectAll(".context-menu").remove();
        }
        
        // Ê∑ªÂä†ÊàêÂëòÊèêÁ§∫
        function addMemberPrompt(parentName) {
            const memberName = prompt("ËØ∑ËæìÂÖ•ÊàêÂëòÂßìÂêçÔºö");
            if (memberName) {
                const birth = prompt("ËØ∑ËæìÂÖ•ÁîüËæ∞Ôºö");
                const spouse = prompt("ËØ∑ËæìÂÖ•ÈÖçÂÅ∂Ôºö");
                const intro = prompt("ËØ∑ËæìÂÖ•ÁÆÄ‰ªãÔºö");
                const residence = prompt("ËØ∑ËæìÂÖ•Â±Ö‰ΩèÂú∞Ôºö");
                
                addMember(parentName, { 
                    name: memberName, 
                    birth: birth || "ÂæÖË°•ÂÖÖ",
                    spouse: spouse || "ÂæÖË°•ÂÖÖ",
                    intro: intro || "ÂæÖË°•ÂÖÖ",
                    residence: residence || "ÂæÖË°•ÂÖÖ"
                });
            }
        }
        
        // Á°ÆËÆ§Âà†Èô§ÊàêÂëò
        function confirmDeleteMember(nodeName) {
            if (confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§"${nodeName}"ÂêóÔºü`)) {
                deleteMember(nodeName);
            }
        }
        
        // Ê∑ªÂä†ÊàêÂëò
        function addMember(parentName, newMember) {
            const addToParent = (node) => {
                if (node.name === parentName) {
                    if (!node.children) {
                        node.children = [];
                    }
                    node.children.push(newMember);
                    return true;
                }
                if (node.children) {
                    for (let child of node.children) {
                        if (addToParent(child)) {
                            return true;
                        }
                    }
                }
                return false;
            };
            
            if (addToParent(familyData)) {
                updateTree();
                saveData(false);
            } else {
                alert(`Êú™ÊâæÂà∞Áà∂ËæàÊàêÂëò: ${parentName}`);
            }
        }
        
        // Ê∑ªÂä†ÈÖçÂÅ∂
        function addSpouseToMember(nodeName) {
            const findAndAddSpouse = (node) => {
                if (node.name === nodeName) {
                    const currentSpouse = node.spouse || 'ÂæÖË°•ÂÖÖ';
                    const newSpouse = prompt("ËØ∑ËæìÂÖ•ÈÖçÂÅ∂ÂßìÂêç:", currentSpouse);
                    
                    if (newSpouse !== null) {
                        node.spouse = newSpouse;
                        return true;
                    }
                    return false;
                }
                if (node.children) {
                    for (let child of node.children) {
                        if (findAndAddSpouse(child)) {
                            return true;
                        }
                    }
                }
                return false;
            };
            
            if (findAndAddSpouse(familyData)) {
                updateTree();
                saveData(false);
            }
        }
        
        // ‰øÆÊîπÊàêÂëò‰ø°ÊÅØ
        function editMember(nodeName) {
            const findAndEdit = (node) => {
                if (node.name === nodeName) {
                    const newName = prompt("‰øÆÊîπÂßìÂêç:", node.name);
                    if (newName) {
                        node.name = newName;
                        node.birth = prompt("‰øÆÊîπÁîüËæ∞:", node.birth || "ÂæÖË°•ÂÖÖ");
                        node.spouse = prompt("‰øÆÊîπÈÖçÂÅ∂:", node.spouse || "ÂæÖË°•ÂÖÖ");
                        node.intro = prompt("‰øÆÊîπÁÆÄ‰ªã:", node.intro || "ÂæÖË°•ÂÖÖ");
                        node.residence = prompt("‰øÆÊîπÂ±Ö‰ΩèÂú∞:", node.residence || "ÂæÖË°•ÂÖÖ");
                        return true;
                    }
                    return false;
                }
                if (node.children) {
                    for (let child of node.children) {
                        if (findAndEdit(child)) {
                            return true;
                        }
                    }
                }
                return false;
            };
            
            if (findAndEdit(familyData)) {
                updateTree();
                saveData(false);
            }
        }
        
        // Âà†Èô§ÊàêÂëò
        function deleteMember(nodeName) {
            const findAndDelete = (node) => {
                if (node.children) {
                    for (let i = 0; i < node.children.length; i++) {
                        if (node.children[i].name === nodeName) {
                            node.children.splice(i, 1);
                            return true;
                        }
                    }
                    for (let child of node.children) {
                        if (findAndDelete(child)) {
                            return true;
                        }
                    }
                }
                return false;
            };
            
            if (findAndDelete(familyData)) {
                updateTree();
                saveData(false);
            }
        }
        
        // Ê∑ªÂä†Êñ∞‰∏ñ‰ª£
        function addGeneration() {
            const parentName = prompt("ËØ∑ËæìÂÖ•Áà∂ËæàÂßìÂêçÔºö");
            if (parentName) {
                const memberName = prompt("ËØ∑ËæìÂÖ•ÊàêÂëòÂßìÂêçÔºö");
                if (memberName) {
                    const birth = prompt("ËØ∑ËæìÂÖ•ÁîüËæ∞Ôºö");
                    const spouse = prompt("ËØ∑ËæìÂÖ•ÈÖçÂÅ∂Ôºö");
                    const intro = prompt("ËØ∑ËæìÂÖ•ÁÆÄ‰ªãÔºö");
                    const residence = prompt("ËØ∑ËæìÂÖ•Â±Ö‰ΩèÂú∞Ôºö");
                    
                    addMember(parentName, { 
                        name: memberName, 
                        birth,
                        spouse,
                        intro,
                        residence
                    });
                }
            }
        }
        
        // ‰øùÂ≠òÊï∞ÊçÆ
        function saveData(showAlert = true) {
            try {
                localStorage.setItem('familyData', JSON.stringify(familyData));
                if (showAlert) alert("Êï∞ÊçÆÂ∑≤‰øùÂ≠ò");
            } catch (e) {
                alert("‰øùÂ≠òÂ§±Ë¥•Ôºö" + e.message);
            }
        }
        
        // ÂØºÂá∫Êï∞ÊçÆ
        function exportData() {
            try {
                const dataStr = JSON.stringify(familyData, null, 2);
                const blob = new Blob([dataStr], {type: "application/json"});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'Èü¶Ê∞èÊóèË∞±Êï∞ÊçÆ.json';
                a.click();
                URL.revokeObjectURL(url); // ÈáäÊîæURLÂØπË±°
            } catch (e) {
                alert("ÂØºÂá∫Â§±Ë¥•Ôºö" + e.message);
            }
        }
        
        // ÂØºÂÖ•Êï∞ÊçÆ
        function importData() {
            const fileInput = document.getElementById('importFile');
            const file = fileInput.files[0];
            
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        // È™åËØÅÊï∞ÊçÆÊ†ºÂºè
                        if (!data.name) {
                            throw new Error("Êï∞ÊçÆÊ†ºÂºè‰∏çÊ≠£Á°Æ");
                        }
                        familyData = data;
                        updateTree();
                        saveData(false);
                        alert("Êï∞ÊçÆÂØºÂÖ•ÊàêÂäü");
                    } catch (error) {
                        alert("ÂØºÂÖ•Â§±Ë¥•ÔºåÊñá‰ª∂Ê†ºÂºèÈîôËØØ: " + error.message);
                    }
                };
                reader.onerror = function() {
                    alert("ËØªÂèñÊñá‰ª∂Êó∂ÂèëÁîüÈîôËØØ");
                };
                reader.readAsText(file);
            }
        }
    </script>
</body>
</html>