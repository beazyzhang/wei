<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éŸ¦æ°ä¼šå›½å…¬æ—è°±</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@500&display=swap" rel="stylesheet">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            font-family: 'Noto Serif SC', serif;
            background-color: #000;
            color: #d4a76a;
            margin: 0;
            padding: 20px;
        }
        
        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-bottom: 20px;
        }
        
        .header {
            text-align: center;
            width: 100%;
        }
        
        .header h1 {
            color: #d4a76a;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.3);
            margin-bottom: 10px;
        }
        
        .header h1::before {
            content: 'ğŸ®';
            margin-right: 15px;
            font-size: 0.8em;
        }
        
        .header h3 {
            color: #8d6e63;
            font-weight: normal;
            margin-bottom: 0;
        }
        
        /* æ·»åŠ æ„Ÿå¹å·æ³¨é‡Šæ ·å¼ */
        .info-icon {
            display: inline-block;
            width: 18px;
            height: 18px;
            background-color: #d4a76a;
            color: #000;
            border-radius: 50%;
            text-align: center;
            line-height: 18px;
            font-size: 14px;
            font-weight: bold;
            margin-left: 10px;
            cursor: pointer;
            transition: all 0.3s;
            vertical-align: middle;
        }
        
        .info-icon:hover {
            background-color: #c09559;
            transform: scale(1.1);
        }
        
        .history-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .history-content {
            background-color: rgba(0, 0, 0, 0.9);
            border: 2px solid #d4a76a;
            border-radius: 8px;
            padding: 25px;
            width: 80%;
            max-width: 600px;
            color: #d4a76a;
            position: relative;
            box-shadow: 0 0 20px rgba(212, 167, 106, 0.3);
        }
        
        .history-content h3 {
            text-align: center;
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 22px;
            border-bottom: 1px solid rgba(212, 167, 106, 0.3);
            padding-bottom: 10px;
        }
        
        .ancestry-chart {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 20px 0;
            padding: 15px;
            background-color: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(212, 167, 106, 0.3);
            border-radius: 5px;
        }
        
        .ancestor {
            text-align: center;
            padding: 10px 15px;
            margin: 5px 0;
            background-color: rgba(212, 167, 106, 0.1);
            border: 1px solid rgba(212, 167, 106, 0.5);
            border-radius: 5px;
            font-size: 16px;
            font-weight: bold;
            min-width: 200px;
        }
        
        .ancestor-title {
            display: block;
            font-size: 12px;
            font-weight: normal;
            color: #a88c5d;
            margin-top: 5px;
        }
        
        .ancestor-line {
            height: 20px;
            width: 2px;
            background-color: #d4a76a;
        }
        
        .current-ancestor {
            background-color: rgba(212, 167, 106, 0.3);
            border: 2px solid #d4a76a;
        }
        
        .history-content p {
            line-height: 1.8;
            font-size: 16px;
            text-indent: 2em;
            margin-bottom: 15px;
        }
        
        .history-content .signature {
            text-align: right;
            text-indent: 0;
            font-style: italic;
            margin-top: 20px;
            margin-bottom: 5px;
        }
        
        .close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 24px;
            color: #d4a76a;
            cursor: pointer;
            transition: color 0.3s;
        }
        
        .close-btn:hover {
            color: #c09559;
        }
        
        /* å…¶ä»–æ ·å¼ä¿æŒä¸å˜ */
        
        .family-rules {
            position: absolute;
            top: 20px;
            left: 20px;
            width: 380px;
            padding: 10px;
            background-color: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(212, 167, 106, 0.3);
            border-radius: 5px;
            font-size: 12px;
            line-height: 1.5;
            color: #d4a76a;
            z-index: 100;
            max-height: calc(100vh - 93px);
            text-align: center;
            overflow-y: auto;
        }
        
        .family-rules h4 {
            margin-top: 0;
            margin-bottom: 5px;
            font-weight: bold;
            text-align: center;
            font-size: 14px;
        }
        
        .family-rules p {
            margin: 0;
            text-align: center;
        }
        
        .editor-panel {
            display: flex;
            flex-direction: row;
            gap: 10px;
            padding: 10px;
            border: 1px solid #d4a76a;
            border-radius: 5px;
            background-color: rgba(0, 0, 0, 0.5);
            margin-bottom: 0;
            position: absolute;
            right: 20px;
            bottom: calc(100vh - 93px - 20px);
            height: fit-content;
            z-index: 100;
        }
        
        .editor-panel button {
            background: #d4a76a;
            color: #000;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            width: 100px;
            text-align: center;
            transition: background-color 0.3s;
        }
        
        .editor-panel button:hover {
            background-color: #c09559;
        }
        
        .file-upload {
            position: relative;
            display: inline-block;
        }
        
        .file-upload input[type="file"] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        
        .file-upload label {
            background: #d4a76a;
            color: #000;
            padding: 8px 16px;
            border-radius: 5px;
            display: inline-block;
            cursor: pointer;
            width: 68px;
            text-align: center;
            transition: background-color 0.3s;
        }
        
        .file-upload label:hover {
            background-color: #c09559;
        }
        
        #family-tree {
            width: 100%;
            height: calc(100vh - 180px); /* ä»200pxå‡å°‘åˆ°180pxï¼Œç›¸å½“äºå¢åŠ 20pxé«˜åº¦ */
            border: 2px solid #d4a76a;
            border-radius: 5px;
            overflow: hidden;
            margin-top: 20px; /* ä¸ä¸Šæ–¹å…ƒç´ ä¿æŒä¸€å®šè·ç¦» */
        }
        
        .node circle {
            fill: #f9e8c7;
            stroke: #d4a76a;
            stroke-width: 2px;
            transition: fill 0.3s;
        }
        
        .ancestor-node circle {
            fill: rgba(249, 232, 199, 0.6);
            stroke: rgba(212, 167, 106, 0.7);
            stroke-width: 1.5px;
        }
        
        .ancestor-node text {
            opacity: 0.8;
        }
        
        .node:hover circle {
            fill: #e6d0a9;
        }
        
        .ancestor-node:hover circle {
            fill: rgba(230, 208, 169, 0.7);
        }
        
        .node text {
            font: 12px 'Noto Serif SC';
            pointer-events: none;
        }
        
        .link {
            fill: none;
            stroke: #8d6e63;
            stroke-width: 2px;
        }
        
        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: #d4a76a;
            border: 1px solid #d4a76a;
            border-radius: 5px;
            padding: 10px;
            pointer-events: none;
            opacity: 0;
            max-width: 250px;
            transition: opacity 0.3s;
        }
        
        .context-menu {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            color: #d4a76a;
            border: 1px solid #d4a76a;
            border-radius: 5px;
            padding: 5px 0;
            z-index: 1000;
        }
        
        .context-menu div {
            padding: 8px 15px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .context-menu div:hover {
            background: rgba(212, 167, 106, 0.2);
        }
        
        .generation-label {
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div class="family-rules">
        <h4>åˆæ—å…¬çº¦å…«æ¡</h4>
        <p>ä¸€ã€æœ¬æ—åŒäººåº”éµå®ˆå›½å®¶æ³•å¾‹ã€‚äºŒã€ä¸å¾—è´ªæ±¡ç›—çªƒã€ä¸å¾—å¥¸æ·«è°ƒæˆå¦‡å¥³ã€‚ä¸‰ã€ä¸å¾—å¸æ¯’ã€èµŒåšã€‚å››ã€ä¸å¾—è¯¬å‘Šé™·å®³ä»–äººã€‚äº”ã€ä¸å¾—æ¬ºå‹å’Œæ‰“éª‚ä»–äººã€‚å…­ã€ä¸å¾—è´¥åæ—æœ›ã€‚ä¸ƒã€è¦å°Šè€çˆ±å¹¼ã€ç¦æ—å’Œé‚»ã€‚å…«ã€ä¸å‡†æ“…è‡ªåˆ æ”¹æ—è°±å†…è®°è½½ã€‚</p>
    </div>
    
    <div class="header-container">
        <div class="header">
            <h1>éŸ¦æ°ä¼šå›½å…¬æ—è°±</h1>
            <h3>ä¼ æ‰¿æœ‰åº å°Šç¥–æ•¬å®—<span class="info-icon" id="historyInfo">!</span></h3>
        </div>
    </div>
    
    <!-- æ·»åŠ å†å²ä¿¡æ¯æ¨¡æ€æ¡† -->
    <div class="history-modal" id="historyModal">
        <div class="history-content">
            <span class="close-btn" id="closeModal">&times;</span>
            <h3>ä¼šå›½å…¬å²ç•¥</h3>
            <div class="ancestry-chart">
                <div class="ancestor">éŸ¦åº”é‚¦ï¼ˆæ›¾ç¥–çˆ¶ï¼‰<br><span class="ancestor-title">å—å®‹é’¦ç‚¹æ­¦çŠ¶å…ƒï¼Œåœ¨å—äº¬ç«‹åº”å¤©åºœï¼Œå…ƒæœå±±ä¸œæç£</span></div>
                <div class="ancestor-line"></div>
                <div class="ancestor">éŸ¦å½¦æ˜¥ï¼ˆç¥–çˆ¶ï¼‰<br><span class="ancestor-title">å…ƒæœå…µéƒ¨å‰Œéƒï¼Œå°†å†›<br>å¥‰æ—¨é¢†å…«åƒå°†å£«é•‡å®ˆäº”ç¾ŠåŸï¼ˆå¹¿å·ï¼‰ï¼Œç«‹å—é›„åºœ</span></div>
                <div class="ancestor-line"></div>
                <div class="ancestor">éŸ¦èƒœç™»ï¼ˆçˆ¶äº²ï¼‰<br><span class="ancestor-title">æ­¦å®˜</span></div>
                <div class="ancestor-line"></div>
                <div class="ancestor current-ancestor">éŸ¦ä¼šå›½<br><span class="ancestor-title">æ˜æœå…µéƒ¨å°šä¹¦ï¼Œæ­£äºŒå“ï¼Œå¤§å°†å†›</span></div>
            </div>
            <p>éŸ¦ä¼šå›½ç³»æ˜æœå…µéƒ¨å°šä¹¦ï¼Œæ­£äºŒå“ï¼Œå¤§å°†å†›ï¼Œæ­¦å®˜èƒœç™»å…¬ä¹‹å­ã€‚</p>
            <p>äºæ˜æœæ´ªæ­¦åä¸€å¹´ï¼ˆå…¬å…ƒ 1378 å¹´ï¼‰æˆŠåˆå¹´äº”æœˆå»¿ä¸ƒæ—¥å¯…æ—¶åœ¨å—é›„å‡ºç”Ÿã€‚å…¶ç¥–çˆ¶éŸ¦å½¦æ˜¥æ˜¯å…ƒæœå…µéƒ¨å‰Œéƒï¼Œå°†å†›ã€‚å¥‰æ—¨é¢†å…«åƒå°†å£«é•‡å®ˆäº”ç¾ŠåŸï¼ˆå¹¿å·ï¼‰ï¼Œç«‹å—é›„åºœï¼Œè½ç±å—é›„è¥¿è¡—ã€‚æ›¾ç¥–çˆ¶éŸ¦åº”é‚¦æ˜¯å—å®‹é’¦ç‚¹æ­¦çŠ¶å…ƒï¼Œåœ¨å—äº¬ç«‹åº”å¤©åºœï¼Œå…ƒæœå±±ä¸œæç£ã€‚ä¸Šæœä¼šå›½å…¬ç›´ç³»å®—äº²ï¼Œæœ‰æ±‰æœçˆ¶å­ä¸ç›¸éŸ¦è´¤ã€éŸ¦ç„æˆï¼Œéšæœæ°‘éƒ¨å°šä¹¦éŸ¦æŒºï¼Œå”æœå°šä¹¦å³ä¸ç›¸éŸ¦æŒºï¼Œå…¶å­éŸ¦å¾…ä»·æ­£äºŒå“æ–‡æ˜Œå³ä¸ç›¸ã€‚ä¼šå›½å…¬ä¸Šæ‰¿å…ˆç¥–è¡€è„‰ï¼Œäºæ˜æ´ªæ­¦å»¿å…­å¹´ï¼ˆæ—¶å¹´åå…­å²ï¼‰æ©æˆå«åƒæ€»æ­¦å®˜ï¼Œå¥‰æ—¨ä»å—é›„é¢†å…µä¸€åƒï¼Œè”äºŒåå››å§“å®ˆé¾™æ°´åŸå¿ï¼ˆä»Šç½—å®šå¸‚ï¼‰ï¼Œæ´ªæ­¦å»¿å…«å¹´å›å—é›„æ¥å®¶çœ·åˆ°é¾™æ°´ä»ªå‡¤å²—ï¼ˆç½—å®šåˆ†ç•ŒçŸ³æ’æ‘ï¼Œå±‹åœ°å½¢ï¼šçŠ€ç‰›å–·æ°´ï¼‰å®šå±…ï¼Œç½®ç”°ä¸‰çŸ³å…­æ–—ã€‚å®£å¾·å››å¹´ï¼ˆ1429 å¹´ï¼Œäº”åä¸€å²ï¼‰ä¸­æ­¦è¿›å£«ï¼Œå…¥æœï¼ˆåŒ—äº¬ï¼‰å®˜å‡æ­£äºŒå“å…µéƒ¨å°šä¹¦ï¼ˆç›¸å½“ç°åœ¨çš„å›½é˜²éƒ¨é•¿ï¼‰å¤§å°†å†›ï¼Œå¤«äººææ°ã€æ¨æ°ï¼Œç”Ÿä¹å­ï¼šæ»¨äº®ï¼ˆé˜³æ˜¥ï¼‰ã€æµ·äº®ï¼ˆäº‘æµ®ï¼‰ã€æ³•äº®ï¼ˆç½—å®šï¼‰ã€æ±‰äº®ï¼ˆå—æµ·ï¼‰ã€æ¸­äº®ï¼ˆå²‘æºªï¼‰ã€æ±Ÿäº®ï¼ˆç¦å»ºï¼‰ã€æ²³äº®ï¼ˆæ–°ä¼šï¼‰ã€æ½®äº®ï¼ˆæ¢…å·ï¼‰ã€æ¸­äº®ï¼ˆä¹æ±Ÿï¼‰ï¼Œå‡ä¸ºæ­¦å®˜ã€‚ä¼šå›½å…¬åœ¨æœå»·ä»»èŒå»¿å…«å¹´ï¼Œæ™šå¹´å›ç½—å®šåˆ†ç•Œå±…ä½ã€‚ç»ˆäºæ˜æœæˆåŒ–å…­å¹´ï¼ˆ1470 å¹´ï¼‰åæœˆåˆä¹æ—¥ï¼Œé˜³å¯¿ä¹åä¸‰å²ã€‚åˆè‘¬æ°´æ‘†æœç ï¼ˆçŒªï¼‰å²­ï¼ˆå±±å½¢ï¼šçŒ›è™æ“’çŒªï¼‰ï¼Œè‡³æ¸…å…‰ç»ªç”²ç”³å¹´åäºŒæœˆäºŒåæ—¥è¾°æ—¶è¿è‘¬ç½—é•œä»ªå‡¤æ¡¥ï¼Œåœ°å½¢ä¸ºå¤©é¹…å­µè›‹ï¼Œåœ¨æ³•äº®å°†å†›å¢“å³ä¾§ï¼Œä¸å¤«äººææ°åŒç©´ï¼Œååºšå‘ç”²å…¼ç”³å¯…ã€‚</p>
            <p>ä¼šå›½å…¬åè£”åˆ†å¸ƒåœ¨å›½å†…å¤–æœ‰æ•°åä¸‡äººã€‚</p>
            <p class="signature">åå…«ä¸–è£”å­™ éŸ¦æ°¸çƒ æ’°ç¨¿</p>
            <p class="signature">å»¿å››ä¸–è£”å­™ éŸ¦ç« å»º</p>
        </div>
    </div>
    <div class="editor-panel">
        <button id="add-generation-btn">æ–°å»ºä¸–ä»£</button>
        <button id="save-data-btn">ä¿å­˜æ•°æ®</button>
        <button id="export-data-btn">å¯¼å‡ºæ•°æ®</button>
        <div class="file-upload">
            <label for="importFile">å¯¼å…¥æ•°æ®</label>
            <input type="file" id="importFile" accept=".json">
        </div>
    </div>
    
    <div id="family-tree"></div>
    
     <script>
        // åˆå§‹æ•°æ®
        let familyData = JSON.parse(localStorage.getItem('familyData')) || {
            name: 'éŸ¦åº”é‚¦(æ›¾ç¥–)',
            birth: "å—å®‹",
            intro: "å—å®‹é’¦ç‚¹æ­¦çŠ¶å…ƒï¼Œåœ¨å—äº¬ç«‹åº”å¤©åºœï¼Œå…ƒæœå±±ä¸œæç£",
            isAncestor: true,
            children: [{
                name: 'éŸ¦å½¦æ˜¥(ç¥–çˆ¶)',
                birth: "å…ƒæœ",
                intro: "å…ƒæœå…µéƒ¨å‰Œéƒï¼Œå°†å†›ï¼Œå¥‰æ—¨é¢†å…«åƒå°†å£«é•‡å®ˆäº”ç¾ŠåŸï¼ˆå¹¿å·ï¼‰ï¼Œç«‹å—é›„åºœ",
                isAncestor: true,
                children: [{
                    name: 'éŸ¦èƒœç™»(çˆ¶äº²)',
                    birth: "å…ƒæœ«æ˜åˆ",
                    intro: "æ­¦å®˜",
                    isAncestor: true,
                    children: [
                        {
                            name: 'éŸ¦ä¼šæ–‡(å…„)',
                            birth: "æ˜æœ",
                            intro: "éŸ¦ä¼šå›½ä¹‹å…„",
                            isAncestor: true,
                            children: []
                        },
                        {
                            name: 'éŸ¦ä¼šå›½(å§‹ç¥–)',
                            birth: "æ˜æœæ´ªæ­¦åä¸€å¹´ï¼ˆå…¬å…ƒ1378å¹´ï¼‰",
                            spouse: "ææ°ã€æ¨æ°",
                            intro: "æ˜æœå…µéƒ¨å°šä¹¦ï¼Œæ­£äºŒå“ï¼Œå¤§å°†å†›",
                            children: []
                        },
                        {
                            name: 'éŸ¦ä¼šæ­¦(å¼Ÿ)',
                            birth: "æ˜æœ",
                            intro: "éŸ¦ä¼šå›½ä¹‹å¼Ÿ",
                            isAncestor: true,
                            children: []
                        }
                    ]
                }]
            }]
        };
        
        // å…¨å±€å˜é‡
        let svg, g, zoom;
        let width, height;
        let tree;
        let tooltip;
        let contextMenu;
        const chineseNumbers = ["ä¸€", "äºŒ", "ä¸‰", "å››", "äº”", "å…­", "ä¸ƒ", "å…«", "ä¹", "å", 
                              "åä¸€", "åäºŒ", "åä¸‰", "åå››", "åäº”", "åå…­", "åä¸ƒ", "åå…«", "åä¹", "äºŒå"];
        
        // DOM åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬
            initEventListeners();
            
            // åˆå§‹åŒ–æ ‘å›¾
            initializeTree();
            
            // çª—å£å¤§å°å˜åŒ–æ—¶é‡æ–°åˆå§‹åŒ–
            window.addEventListener('resize', debounce(initializeTree, 250));
        });
        
        // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬
        function initEventListeners() {
            document.getElementById('add-generation-btn').addEventListener('click', addGeneration);
            document.getElementById('save-data-btn').addEventListener('click', saveData);
            document.getElementById('export-data-btn').addEventListener('click', exportData);
            document.getElementById('importFile').addEventListener('change', importData);
            
            // æ·»åŠ å†å²ä¿¡æ¯ç‚¹å‡»äº‹ä»¶
            document.getElementById('historyInfo').addEventListener('click', function() {
                document.getElementById('historyModal').style.display = 'flex';
            });
            
            document.getElementById('closeModal').addEventListener('click', function() {
                document.getElementById('historyModal').style.display = 'none';
            });
            
            // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
            document.getElementById('historyModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    this.style.display = 'none';
                }
            });
            
            // ç‚¹å‡»é¡µé¢ä»»æ„ä½ç½®å…³é—­ä¸Šä¸‹æ–‡èœå•
            document.addEventListener('click', function() {
                hideContextMenu();
            });
        }
        
        // é˜²æŠ–å‡½æ•°
        function debounce(func, wait) {
            let timeout;
            return function() {
                const context = this;
                const args = arguments;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), wait);
            };
        }
        
        // åˆå§‹åŒ–æ ‘å›¾
        function initializeTree() {
            // æ¸…é™¤ç°æœ‰å†…å®¹
            d3.select("#family-tree").html("");
            
            // è·å–å®¹å™¨å°ºå¯¸
            const container = document.getElementById('family-tree');
            width = container.clientWidth;
            height = container.clientHeight;
            
            // åˆ›å»ºSVG
            svg = d3.select("#family-tree")
                .append("svg")
                .attr("width", width)
                .attr("height", height);
            
            // æ·»åŠ ç¼©æ”¾åŠŸèƒ½
            zoom = d3.zoom()
                .scaleExtent([0.1, 3])
                .on("zoom", (event) => {
                    g.attr("transform", event.transform);
                });
            
            svg.call(zoom);
            
            // åˆ›å»ºä¸»è¦å›¾å½¢ç»„
            g = svg.append("g");
            
            // åˆ›å»ºæ ‘å¸ƒå±€
            tree = d3.tree()
                .nodeSize([80, 120])
                .separation((a, b) => a.parent === b.parent ? 1.5 : 2);
            
            // åˆ›å»ºæç¤ºæ¡†
            tooltip = d3.select("body").append("div")
                .attr("class", "tooltip");
            
            // æ¸²æŸ“æ ‘
            updateTree();
        }
        
        // æ›´æ–°æ ‘å›¾
        function updateTree() {
            // å¤„ç†æ•°æ®
            const root = d3.hierarchy(familyData);
            
            // ä¿ç•™æŠ˜å çŠ¶æ€
            root.descendants().forEach(d => {
                if (d.data.collapsed) {
                    d._children = d.children;
                    d.children = null;
                }
            });
            
            // è®¡ç®—èŠ‚ç‚¹ä½ç½®
            tree(root);
            
            // æ¸…é™¤ç°æœ‰å†…å®¹
            g.selectAll("*").remove();
            
            // ç»˜åˆ¶è¿æ¥çº¿
            drawLinks(root);
            
            // ç»˜åˆ¶èŠ‚ç‚¹
            drawNodes(root);
            
            // æ·»åŠ ä»£é™…æ ‡è¯†
            addGenerationLabels(root);
            
            // å±…ä¸­æ˜¾ç¤ºæ ‘
            centerTree(root);
        }
        
        // ç»˜åˆ¶è¿æ¥çº¿
        function drawLinks(root) {
            g.selectAll(".link")
                .data(root.links())
                .enter()
                .append("path")
                .attr("class", "link")
                .attr("d", d => {
                    return `M${d.source.x},${d.source.y}
                            L${d.source.x},${(d.source.y + d.target.y) / 2}
                            L${d.target.x},${(d.source.y + d.target.y) / 2}
                            L${d.target.x},${d.target.y}`;
                });
        }
        
        // ç»˜åˆ¶èŠ‚ç‚¹
        function drawNodes(root) {
            const nodes = g.selectAll(".node")
                .data(root.descendants())
                .enter()
                .append("g")
                .attr("class", d => d.data.isAncestor ? "node ancestor-node" : "node")
                .attr("transform", d => `translate(${d.x},${d.y})`)
                .on("click", toggleChildren)
                .on("contextmenu", showContextMenu)
                .on("mouseover", showTooltip)
                .on("mouseout", hideTooltip);
            
            // ç»˜åˆ¶èŠ‚ç‚¹åœ†å½¢
            nodes.append("circle")
                .attr("r", 30)
                .attr("fill", d => d.data.isAncestor ? "rgba(249, 232, 199, 0.6)" : "#f9e8c7")
                .attr("stroke", d => d.data.isAncestor ? "rgba(212, 167, 106, 0.7)" : "#d4a76a");
            
            // ä¸ºæ”¶èµ·çš„èŠ‚ç‚¹æ·»åŠ ç‰¹æ®Šæ ‡è¯†
            nodes.filter(d => d._children)
                .append("text")
                .attr("class", "collapsed-indicator")
                .text("+")
                .attr("x", 0)
                .attr("y", 40)
                .attr("dy", "0.3em")
                .attr("text-anchor", "middle")
                .attr("fill", "#d4a76a")
                .attr("font-size", "20px");
            
            // ç»˜åˆ¶èŠ‚ç‚¹æ–‡æœ¬
            nodes.append("text")
                .text(d => d.data.name)
                .attr("dy", "0.3em")
                .attr("text-anchor", "middle")
                .attr("fill", d => d.data.isAncestor ? "rgba(0, 0, 0, 0.6)" : "#000");
        }
        
        // æ·»åŠ ä»£é™…æ ‡è¯†
        function addGenerationLabels(root) {
            const maxDepth = d3.max(root.descendants(), d => d.depth);
            
            // æ‰¾åˆ°æ¯ä¸ªæ·±åº¦çš„èŠ‚ç‚¹
            const depthNodes = {};
            root.descendants().forEach(node => {
                if (!depthNodes[node.depth]) {
                    depthNodes[node.depth] = [];
                }
                depthNodes[node.depth].push(node);
            });
            
            // ä¸ºæ¯ä¸ªæ·±åº¦æ·»åŠ ä»£é™…æ ‡è¯†
            for (let i = 0; i <= maxDepth; i++) {
                if (depthNodes[i] && depthNodes[i].length > 0) {
                    if (i === 0) {
                        // ç¬¬ä¸€ä»£çš„èŠ‚ç‚¹
                        addFirstGenerationLabel(depthNodes[i][0]);
                    } else if (i === 1) {
                        // ç¬¬äºŒä»£çš„èŠ‚ç‚¹
                        addSecondGenerationLabel(depthNodes[0][0]);
                    } else {
                        // å…¶ä»–ä»£çš„æ ‡è¯†å¤„ç†é€»è¾‘
                        addOtherGenerationLabels(i, depthNodes[i-1]);
                    }
                }
            }
        }
        
        // æ·»åŠ ç¬¬ä¸€ä»£æ ‡è¯†
        function addFirstGenerationLabel(node) {
            g.append("text")
                .attr("class", "generation-label")
                .text("ä¸€ä¸–")
                .attr("x", node.x)
                .attr("y", node.y - 45)
                .attr("dy", "0.3em")
                .attr("text-anchor", "middle")
                .attr("fill", "#d4a76a")
                .attr("font-size", "16px");
        }
        
        // æ·»åŠ ç¬¬äºŒä»£æ ‡è¯†
        function addSecondGenerationLabel(firstGenNode) {
            g.append("text")
                .attr("class", "generation-label")
                .text("äºŒä¸–")
                .attr("x", firstGenNode.x)
                .attr("y", firstGenNode.y + 75)
                .attr("dy", "0.3em")
                .attr("text-anchor", "middle")
                .attr("fill", "#d4a76a")
                .attr("font-size", "16px");
        }
        
        // æ·»åŠ å…¶ä»–ä»£é™…æ ‡è¯†
        function addOtherGenerationLabels(generation, parentNodes) {
            // æ‰¾åˆ°å½“å‰æ·±åº¦ä¸­æœ‰å­èŠ‚ç‚¹ä¸”å·²å±•å¼€çš„èŠ‚ç‚¹
            const expandedParents = parentNodes.filter(node => 
                node.children && node.children.length > 0
            );
            
            // ä¸ºæ¯ä¸ªå±•å¼€çš„çˆ¶èŠ‚ç‚¹æ·»åŠ ä¸‹ä¸€ä»£æ ‡è¯†
            expandedParents.forEach(parent => {
                g.append("text")
                    .attr("class", "generation-label")
                    .text(chineseNumbers[generation] + "ä¸–")
                    .attr("x", parent.x)
                    .attr("y", parent.y + 75)
                    .attr("dy", "0.3em")
                    .attr("text-anchor", "middle")
                    .attr("fill", "#d4a76a")
                    .attr("font-size", "16px");
            });
        }
        
        // å±…ä¸­æ˜¾ç¤ºæ ‘
        function centerTree(root) {
            const rootNode = root.descendants()[0];
            const initialTransform = d3.zoomIdentity
                .translate(width / 2 - rootNode.x, 100 - rootNode.y)
                .scale(0.8);
            
            svg.call(zoom.transform, initialTransform);
        }
        
        // æŠ˜å /å±•å¼€å­èŠ‚ç‚¹
        function toggleChildren(event, d) {
            event.stopPropagation();
            
            if (d.children) {
                d._children = d.children;
                d.children = null;
                d.data.collapsed = true;
            } else if (d._children) {
                d.children = d._children;
                d._children = null;
                d.data.collapsed = false;
            }
            updateTree();
        }
        
        // æ˜¾ç¤ºæç¤ºæ¡†
        function showTooltip(event, d) {
            let content = `<strong>${d.data.name}</strong>`;
            
            if (d.data.birth && d.data.birth !== 'å¾…è¡¥å……') {
                content += `<br/>ç”Ÿè¾°ï¼š${d.data.birth}`;
            }
            
            if (d.data.spouse && d.data.spouse !== 'å¾…è¡¥å……' && !d.data.isSpouse) {
                content += `<br/>é…å¶ï¼š${d.data.spouse}`;
            }
            
            if (d.data.intro && d.data.intro !== 'å¾…è¡¥å……') {
                content += `<br/>ç®€ä»‹ï¼š${d.data.intro}`;
            }
            
            if (d.data.residence && d.data.residence !== 'å¾…è¡¥å……') {
                content += `<br/>å±…ä½åœ°ï¼š${d.data.residence}`;
            }
            
            tooltip.html(content)
                .style("left", (event.pageX + 10) + "px")
                .style("top", (event.pageY - 28) + "px")
                .style("opacity", 0.9);
        }
        
        // éšè—æç¤ºæ¡†
        function hideTooltip() {
            tooltip.style("opacity", 0);
        }
        
        // æ˜¾ç¤ºå³é”®èœå•
        function showContextMenu(event, d) {
            event.preventDefault();
            event.stopPropagation();
            
            // ç§»é™¤ç°æœ‰èœå•
            hideContextMenu();
            
            // åˆ›å»ºèœå•
            contextMenu = d3.select("body")
                .append("div")
                .attr("class", "context-menu")
                .style("left", event.pageX + "px")
                .style("top", event.pageY + "px");
            
            // æ·»åŠ èœå•é¡¹
            const options = [
                { text: 'æ·»åŠ æˆå‘˜', action: () => addMemberPrompt(d.data.name) },
                { text: 'æ·»åŠ é…å¶', action: () => addSpouseToMember(d.data.name) },
                { text: 'ä¿®æ”¹æˆå‘˜', action: () => editMember(d.data.name) },
                { text: 'åˆ é™¤æˆå‘˜', action: () => confirmDeleteMember(d.data.name) }
            ];
            
            options.forEach(option => {
                contextMenu.append("div")
                    .text(option.text)
                    .on("click", (e) => {
                        e.stopPropagation();
                        hideContextMenu();
                        option.action();
                    });
            });
        }
        
        // éšè—å³é”®èœå•
        function hideContextMenu() {
            d3.selectAll(".context-menu").remove();
        }
        
        // æ·»åŠ æˆå‘˜æç¤º
        function addMemberPrompt(parentName) {
            const memberName = prompt("è¯·è¾“å…¥æˆå‘˜å§“åï¼š");
            if (memberName) {
                const birth = prompt("è¯·è¾“å…¥ç”Ÿè¾°ï¼š");
                const spouse = prompt("è¯·è¾“å…¥é…å¶ï¼š");
                const intro = prompt("è¯·è¾“å…¥ç®€ä»‹ï¼š");
                const residence = prompt("è¯·è¾“å…¥å±…ä½åœ°ï¼š");
                
                addMember(parentName, { 
                    name: memberName, 
                    birth: birth || "å¾…è¡¥å……",
                    spouse: spouse || "å¾…è¡¥å……",
                    intro: intro || "å¾…è¡¥å……",
                    residence: residence || "å¾…è¡¥å……"
                });
            }
        }
        
        // ç¡®è®¤åˆ é™¤æˆå‘˜
        function confirmDeleteMember(nodeName) {
            if (confirm(`ç¡®å®šè¦åˆ é™¤"${nodeName}"å—ï¼Ÿ`)) {
                deleteMember(nodeName);
            }
        }
        
        // æ·»åŠ æˆå‘˜
        function addMember(parentName, newMember) {
            const addToParent = (node) => {
                if (node.name === parentName) {
                    if (!node.children) {
                        node.children = [];
                    }
                    node.children.push(newMember);
                    return true;
                }
                if (node.children) {
                    for (let child of node.children) {
                        if (addToParent(child)) {
                            return true;
                        }
                    }
                }
                return false;
            };
            
            if (addToParent(familyData)) {
                updateTree();
                saveData(false);
            } else {
                alert(`æœªæ‰¾åˆ°çˆ¶è¾ˆæˆå‘˜: ${parentName}`);
            }
        }
        
        // æ·»åŠ é…å¶
        function addSpouseToMember(nodeName) {
            const findAndAddSpouse = (node) => {
                if (node.name === nodeName) {
                    const currentSpouse = node.spouse || 'å¾…è¡¥å……';
                    const newSpouse = prompt("è¯·è¾“å…¥é…å¶å§“å:", currentSpouse);
                    
                    if (newSpouse !== null) {
                        node.spouse = newSpouse;
                        return true;
                    }
                    return false;
                }
                if (node.children) {
                    for (let child of node.children) {
                        if (findAndAddSpouse(child)) {
                            return true;
                        }
                    }
                }
                return false;
            };
            
            if (findAndAddSpouse(familyData)) {
                updateTree();
                saveData(false);
            }
        }
        
        // ä¿®æ”¹æˆå‘˜ä¿¡æ¯
        function editMember(nodeName) {
            const findAndEdit = (node) => {
                if (node.name === nodeName) {
                    const newName = prompt("ä¿®æ”¹å§“å:", node.name);
                    if (newName) {
                        node.name = newName;
                        node.birth = prompt("ä¿®æ”¹ç”Ÿè¾°:", node.birth || "å¾…è¡¥å……");
                        node.spouse = prompt("ä¿®æ”¹é…å¶:", node.spouse || "å¾…è¡¥å……");
                        node.intro = prompt("ä¿®æ”¹ç®€ä»‹:", node.intro || "å¾…è¡¥å……");
                        node.residence = prompt("ä¿®æ”¹å±…ä½åœ°:", node.residence || "å¾…è¡¥å……");
                        return true;
                    }
                    return false;
                }
                if (node.children) {
                    for (let child of node.children) {
                        if (findAndEdit(child)) {
                            return true;
                        }
                    }
                }
                return false;
            };
            
            if (findAndEdit(familyData)) {
                updateTree();
                saveData(false);
            }
        }
        
        // åˆ é™¤æˆå‘˜
        function deleteMember(nodeName) {
            const findAndDelete = (node) => {
                if (node.children) {
                    for (let i = 0; i < node.children.length; i++) {
                        if (node.children[i].name === nodeName) {
                            node.children.splice(i, 1);
                            return true;
                        }
                    }
                    for (let child of node.children) {
                        if (findAndDelete(child)) {
                            return true;
                        }
                    }
                }
                return false;
            };
            
            if (findAndDelete(familyData)) {
                updateTree();
                saveData(false);
            }
        }
        
        // æ·»åŠ æ–°ä¸–ä»£
        function addGeneration() {
            const parentName = prompt("è¯·è¾“å…¥çˆ¶è¾ˆå§“åï¼š");
            if (parentName) {
                const memberName = prompt("è¯·è¾“å…¥æˆå‘˜å§“åï¼š");
                if (memberName) {
                    const birth = prompt("è¯·è¾“å…¥ç”Ÿè¾°ï¼š");
                    const spouse = prompt("è¯·è¾“å…¥é…å¶ï¼š");
                    const intro = prompt("è¯·è¾“å…¥ç®€ä»‹ï¼š");
                    const residence = prompt("è¯·è¾“å…¥å±…ä½åœ°ï¼š");
                    
                    addMember(parentName, { 
                        name: memberName, 
                        birth,
                        spouse,
                        intro,
                        residence
                    });
                }
            }
        }
        
        // ä¿å­˜æ•°æ®
        function saveData(showAlert = true) {
            try {
                localStorage.setItem('familyData', JSON.stringify(familyData));
                if (showAlert) alert("æ•°æ®å·²ä¿å­˜");
            } catch (e) {
                alert("ä¿å­˜å¤±è´¥ï¼š" + e.message);
            }
        }
        
        // å¯¼å‡ºæ•°æ®
        function exportData() {
            try {
                const dataStr = JSON.stringify(familyData, null, 2);
                const blob = new Blob([dataStr], {type: "application/json"});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'éŸ¦æ°æ—è°±æ•°æ®.json';
                a.click();
                URL.revokeObjectURL(url); // é‡Šæ”¾URLå¯¹è±¡
            } catch (e) {
                alert("å¯¼å‡ºå¤±è´¥ï¼š" + e.message);
            }
        }
        
        // å¯¼å…¥æ•°æ®
        function importData() {
            const fileInput = document.getElementById('importFile');
            const file = fileInput.files[0];
            
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        // éªŒè¯æ•°æ®æ ¼å¼
                        if (!data.name) {
                            throw new Error("æ•°æ®æ ¼å¼ä¸æ­£ç¡®");
                        }
                        familyData = data;
                        updateTree();
                        saveData(false);
                        alert("æ•°æ®å¯¼å…¥æˆåŠŸ");
                    } catch (error) {
                        alert("å¯¼å…¥å¤±è´¥ï¼Œæ–‡ä»¶æ ¼å¼é”™è¯¯: " + error.message);
                    }
                };
                reader.onerror = function() {
                    alert("è¯»å–æ–‡ä»¶æ—¶å‘ç”Ÿé”™è¯¯");
                };
                reader.readAsText(file);
            }
        }
    </script>
</body>
</html>